# GenieUs Cloud Build Configuration
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸¦è¡Œãƒ“ãƒ«ãƒ‰&ãƒ‡ãƒ—ãƒ­ã‚¤

steps:
  # Step 1: ç’°å¢ƒå¤‰æ•°ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'setup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”§ Cloud Buildç’°å¢ƒè¨­å®š..."
        gcloud config set project $_GCP_PROJECT_ID
        echo "Project: $_GCP_PROJECT_ID"
        echo "Environment: $_ENVIRONMENT"
        echo "Region: $_GCP_REGION"

  # Step 2: å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'enable-apis'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”Œ å¿…è¦ãªGCP APIã‚’æœ‰åŠ¹åŒ–ä¸­..."
        gcloud services enable run.googleapis.com
        gcloud services enable cloudbuild.googleapis.com
        gcloud services enable containerregistry.googleapis.com
        gcloud services enable artifactregistry.googleapis.com
        gcloud services enable aiplatform.googleapis.com
        echo "âœ… APIæœ‰åŠ¹åŒ–å®Œäº†"

  # Step 3: IAMã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'setup-iam'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ‘¤ IAMã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š..."
        
        # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆï¼ˆæ—¢å­˜ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        if ! gcloud iam service-accounts describe genius-backend-sa@$_GCP_PROJECT_ID.iam.gserviceaccount.com &>/dev/null; then
          echo "Creating service account..."
          gcloud iam service-accounts create genius-backend-sa \
            --display-name="Genius Backend Service Account" \
            --description="Service account for Genius backend Cloud Run service"
        else
          echo "Service account already exists"
        fi
        
        # å¿…è¦ãªæ¨©é™ä»˜ä¸
        for role in "roles/aiplatform.user" "roles/storage.objectAdmin" "roles/logging.logWriter" "roles/monitoring.metricWriter"; do
          echo "Granting role: $$role"
          gcloud projects add-iam-policy-binding $_GCP_PROJECT_ID \
            --member="serviceAccount:genius-backend-sa@$_GCP_PROJECT_ID.iam.gserviceaccount.com" \
            --role="$$role" \
            --quiet || true
        done
        
        echo "âœ… IAMè¨­å®šå®Œäº†"

  # Step 4: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¸¦è¡Œå‡¦ç†ï¼‰
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-backend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’Cloud Buildã§ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        
        cd backend
        
        # ã‚µãƒ¼ãƒ“ã‚¹åæ±ºå®šã¨ãƒ‡ãƒ—ãƒ­ã‚¤
        if [ "$_ENVIRONMENT" = "production" ]; then
          echo "Service: genius-backend"
          gcloud run deploy "genius-backend" \
            --source . \
            --platform managed \
            --region $_GCP_REGION \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 \
            --memory 2Gi \
            --min-instances 1 \
            --max-instances 5 \
            --service-account genius-backend-sa@$_GCP_PROJECT_ID.iam.gserviceaccount.com \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=$_GCP_PROJECT_ID" \
            --set-env-vars "ENVIRONMENT=$_ENVIRONMENT" \
            --set-env-vars "GOOGLE_GENAI_USE_VERTEXAI=True" \
            --set-env-vars "GOOGLE_CLOUD_LOCATION=us-central1" \
            --set-env-vars "ROUTING_STRATEGY=$_ROUTING_STRATEGY" \
            --set-env-vars "LOG_LEVEL=$_LOG_LEVEL" \
            --timeout 300 \
            --quiet
          
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URLå–å¾—
          gcloud run services describe "genius-backend" \
            --platform managed \
            --region $_GCP_REGION \
            --format 'value(status.url)' > /workspace/backend_url.txt
        else
          echo "Service: genius-backend-$_ENVIRONMENT"
          gcloud run deploy "genius-backend-$_ENVIRONMENT" \
            --source . \
            --platform managed \
            --region $_GCP_REGION \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 \
            --memory 2Gi \
            --min-instances 0 \
            --max-instances 3 \
            --service-account genius-backend-sa@$_GCP_PROJECT_ID.iam.gserviceaccount.com \
            --add-volume name=data-volume,type=cloud-storage,bucket=genius-$_ENVIRONMENT-data \
            --add-volume-mount volume=data-volume,mount-path=/app/data \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=$_GCP_PROJECT_ID" \
            --set-env-vars "ENVIRONMENT=$_ENVIRONMENT" \
            --set-env-vars "GOOGLE_GENAI_USE_VERTEXAI=True" \
            --set-env-vars "GOOGLE_CLOUD_LOCATION=us-central1" \
            --set-env-vars "ROUTING_STRATEGY=$_ROUTING_STRATEGY" \
            --set-env-vars "LOG_LEVEL=$_LOG_LEVEL" \
            --timeout 300 \
            --quiet
          
          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URLå–å¾—ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã«å†å–å¾—ï¼‰
          sleep 10  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿ
          gcloud run services describe "genius-backend-$_ENVIRONMENT" \
            --platform managed \
            --region $_GCP_REGION \
            --format 'value(status.url)' > /workspace/backend_url.txt
        fi
        
        echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $$(cat /workspace/backend_url.txt)"

  # Step 5: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¸¦è¡Œå‡¦ç†ï¼‰
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-frontend'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "âš›ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’Cloud Buildã§ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
        
        cd frontend
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰URLã‚’å–å¾—ï¼ˆä¾å­˜é–¢ä¿‚ã®ãŸã‚å¾…æ©Ÿï¼‰
        while [ ! -f /workspace/backend_url.txt ]; do
          echo "Waiting for backend URL..."
          sleep 5
        done
        # ã‚µãƒ¼ãƒ“ã‚¹åæ±ºå®šã¨ãƒ‡ãƒ—ãƒ­ã‚¤
        echo "Backend URL: $$(cat /workspace/backend_url.txt)"
        
        if [ "$_ENVIRONMENT" = "production" ]; then
          echo "Service: genius-frontend"
          if gcloud run deploy "genius-frontend" \
            --source . \
            --platform managed \
            --region $_GCP_REGION \
            --allow-unauthenticated \
            --port 3000 \
            --cpu 1 \
            --memory 1Gi \
            --min-instances 1 \
            --max-instances 10 \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "NEXT_PUBLIC_API_BASE_URL=$$(cat /workspace/backend_url.txt)" \
            --set-env-vars "NEXTAUTH_SECRET=$_NEXTAUTH_SECRET" \
            --set-env-vars "GOOGLE_CLIENT_ID=$_GOOGLE_CLIENT_ID" \
            --set-env-vars "GOOGLE_CLIENT_SECRET=$_GOOGLE_CLIENT_SECRET" \
            --timeout 300 \
            --quiet; then
            
            # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLå–å¾—
            sleep 10  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿ
            gcloud run services describe "genius-frontend" \
              --platform managed \
              --region $_GCP_REGION \
              --format 'value(status.url)' > /workspace/frontend_url.txt
          else
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•— - æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®URLã‚’å–å¾—"
            gcloud run services describe "genius-frontend" \
              --platform managed \
              --region $_GCP_REGION \
              --format 'value(status.url)' > /workspace/frontend_url.txt || echo "https://frontend-deploy-failed" > /workspace/frontend_url.txt
          fi
        else
          echo "Service: genius-frontend-$_ENVIRONMENT"
          if gcloud run deploy "genius-frontend-$_ENVIRONMENT" \
            --source . \
            --platform managed \
            --region $_GCP_REGION \
            --allow-unauthenticated \
            --port 3000 \
            --cpu 1 \
            --memory 1Gi \
            --min-instances 0 \
            --max-instances 5 \
            --set-env-vars "NODE_ENV=production" \
            --set-env-vars "NEXT_PUBLIC_API_BASE_URL=$$(cat /workspace/backend_url.txt)" \
            --set-env-vars "NEXTAUTH_SECRET=$_NEXTAUTH_SECRET" \
            --set-env-vars "GOOGLE_CLIENT_ID=$_GOOGLE_CLIENT_ID" \
            --set-env-vars "GOOGLE_CLIENT_SECRET=$_GOOGLE_CLIENT_SECRET" \
            --timeout 300 \
            --quiet; then
            
            # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰URLå–å¾—ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã«å†å–å¾—ï¼‰
            sleep 10  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…æ©Ÿ
            gcloud run services describe "genius-frontend-$_ENVIRONMENT" \
              --platform managed \
              --region $_GCP_REGION \
              --format 'value(status.url)' > /workspace/frontend_url.txt
          else
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•— - æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®URLã‚’å–å¾—"
            gcloud run services describe "genius-frontend-$_ENVIRONMENT" \
              --platform managed \
              --region $_GCP_REGION \
              --format 'value(status.url)' > /workspace/frontend_url.txt || echo "https://frontend-deploy-failed" > /workspace/frontend_url.txt
          fi
        fi
        
        echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $$(cat /workspace/frontend_url.txt)"
    waitFor: ['deploy-backend']

  # Step 5.5: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®CORSè¨­å®šæ›´æ–°
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'update-backend-cors'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®CORSè¨­å®šã‚’æ›´æ–°ä¸­..."
        
        FRONTEND_URL=$$(cat /workspace/frontend_url.txt)
        echo "Frontend URL for CORS: $$FRONTEND_URL"
        
        if [ "$_ENVIRONMENT" = "production" ]; then
          SERVICE_NAME="genius-backend"
        else
          SERVICE_NAME="genius-backend-$_ENVIRONMENT"
        fi
        
        echo "Updating CORS settings for: $$SERVICE_NAME"
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«CORSç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
        gcloud run services update "$$SERVICE_NAME" \
          --region="$_GCP_REGION" \
          --update-env-vars "CORS_ORIGINS=$$FRONTEND_URL" \
          --update-env-vars "NEXTAUTH_URL=$$FRONTEND_URL" \
          --quiet
          
        echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰CORSè¨­å®šå®Œäº†"
    waitFor: ['deploy-frontend']

  # Step 6: å¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'cleanup-revisions'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§¹ å¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
        
        # å„ã‚µãƒ¼ãƒ“ã‚¹ã®å¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆæœ€æ–°3ã¤ã‚’ä¿æŒï¼‰
        for service in "genius-backend-$_ENVIRONMENT" "genius-frontend-$_ENVIRONMENT"; do
          echo "Cleaning up service: $$service"
          
          # æœ€æ–°3ã¤ä»¥å¤–ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦å‰Šé™¤
          OLD_REVISIONS=$$(gcloud run revisions list \
            --service="$$service" \
            --region="$_GCP_REGION" \
            --format="value(metadata.name)" \
            --sort-by="~metadata.creationTimestamp" \
            --limit=1000 | tail -n +4)
          
          if [ -n "$$OLD_REVISIONS" ]; then
            echo "Deleting old revisions for $$service:"
            echo "$$OLD_REVISIONS" | while read revision; do
              echo "  - $$revision"
              gcloud run revisions delete "$$revision" \
                --region="$_GCP_REGION" \
                --quiet || echo "Failed to delete $$revision"
            done
          else
            echo "No old revisions to delete for $$service"
          fi
        done
        
        echo "âœ… ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
    waitFor: ['update-backend-cors']

  # Step 7: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»å‹•ä½œç¢ºèª
  - name: 'gcr.io/cloud-builders/curl'
    id: 'health-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        
        echo "Backend URL: $$(cat /workspace/backend_url.txt)"
        echo "Frontend URL: $$(cat /workspace/frontend_url.txt)"
        
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        echo "Checking backend health..."
        if curl -f "$$(cat /workspace/backend_url.txt)/health" -m 30; then
          echo "âœ… Backend health check OK"
        else
          echo "âš ï¸ Backend health check failed"
        fi
        
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        echo "Checking frontend..."
        if curl -f "$$(cat /workspace/frontend_url.txt)" -m 30; then
          echo "âœ… Frontend health check OK"
        else
          echo "âš ï¸ Frontend health check failed"
        fi
        
        echo ""
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚µãƒãƒªãƒ¼"
        echo "=========================="
        echo "Environment: $_ENVIRONMENT"
        echo "Project: $_GCP_PROJECT_ID"
        echo "Region: $_GCP_REGION"
        echo ""
        
        # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®çŠ¶æ…‹ç¢ºèª
        FRONTEND_URL=$$(cat /workspace/frontend_url.txt)
        if [ "$$FRONTEND_URL" = "https://frontend-deploy-failed" ]; then
          echo "âš ï¸  Frontend: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ï¼ˆæ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šï¼‰"
        else
          echo "âœ… Frontend URL: $$FRONTEND_URL"
        fi
        
        echo "âœ… Backend URL: $$(cat /workspace/backend_url.txt)"
        echo "âœ… API Docs: $$(cat /workspace/backend_url.txt)/docs"
        echo "=========================="
    waitFor: ['cleanup-revisions']

# ç½®æ›å¤‰æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
substitutions:
  _GCP_PROJECT_ID: 'your-project-id'
  _ENVIRONMENT: 'staging'
  _GCP_REGION: 'asia-northeast1'
  _ROUTING_STRATEGY: 'enhanced'
  _LOG_LEVEL: 'INFO'
  _NEXTAUTH_SECRET: 'default-nextauth-secret'
  _GOOGLE_CLIENT_ID: ''
  _GOOGLE_CLIENT_SECRET: ''

# ãƒ“ãƒ«ãƒ‰è¨­å®š
timeout: 1200s
options:
  # ãƒ­ã‚°è¨­å®š
  logging: CLOUD_LOGGING_ONLY
  
  # ãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆä¸¦è¡Œå‡¦ç†ã®ãŸã‚ãƒã‚¤ã‚¹ãƒšãƒƒã‚¯ï¼‰
  machineType: 'E2_HIGHCPU_8'
  
  # ç’°å¢ƒå¤‰æ•°
  env:
    - 'CLOUDSDK_COMPUTE_REGION=$_GCP_REGION'
    - 'CLOUDSDK_RUN_REGION=$_GCP_REGION'

# æˆæœç‰©ï¼ˆãƒ­ã‚°ä¿å­˜ï¼‰
artifacts:
  objects:
    location: 'gs://$_GCP_PROJECT_ID-build-artifacts'
    paths: 
      - '/workspace/*.txt'