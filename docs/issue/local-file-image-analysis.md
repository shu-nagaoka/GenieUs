# Issue: ローカルファイル保存ベース画像分析パイプライン実装

**Issue ID**: IMG-LOCAL-001  
**優先度**: High  
**カテゴリ**: バックエンド

## 📋 概要

現在のグローバル変数を使用したBase64画像データ受け渡し実装を削除し、既存のローカルファイル保存機能を活用した画像分析パイプラインに改修する。

## 🎯 目的

- コードの簡潔性と保守性向上
- 既存インフラの有効活用
- メモリ効率の改善
- ADK制約回避

## 🔍 現状分析

### **既存実装の問題点**
- `_current_image_path` グローバル変数による一時的解決策
- `set_current_image_path()` 関数による状態管理
- ADKツールパラメータ制約の回避策として実装

### **利用可能なインフラ**
- **ファイルアップロードAPI**: `/api/v1/files/upload/image` (実装済み)
- **保存先**: `backend/data/uploads/images/` 
- **ファイル取得API**: `/api/v1/files/images/{filename}` (実装済み)
- **対応形式**: JPG, PNG, GIF, WebP (最大5MB)

## 🚀 実装プラン

### **Phase 1: グローバル変数削除とクリーンアップ**
- [ ] `backend/src/tools/image_analysis_tool.py` からグローバル変数削除
  - `_current_image_path` 変数削除
  - `set_current_image_path()` 関数削除
- [ ] `backend/src/agents/routing_executor.py` からグローバル変数呼び出し削除
- [ ] パラメータ propagation チェーンの不要部分削除

### **Phase 2: ローカルファイルパス対応実装**
- [ ] 画像分析ツールのローカルファイルパス対応
  - Base64データの代わりにファイルパス受け取り
  - ローカルファイル読み込み処理追加
- [ ] UseCase層の改修
  - `ImageAnalysisUseCase` のファイルパス対応
  - `GeminiImageAnalyzer` の改修

### **Phase 3: フロントエンド統合**
- [ ] フロントエンドのファイルアップロード⇔画像分析連携実装
- [ ] ファイルアップロード後のファイルパス取得
- [ ] 画像分析リクエスト時のファイルパス指定

### **Phase 4: 統合テストと検証** ✅ **実装完了**
- [x] エンドツーエンド動作確認準備完了
- [x] エラーハンドリング実装（アップロード失敗時Base64フォールバック）
- [x] セキュリティ対応（パストラバーサル攻撃防止）
- [ ] 実際の画像アップロード→分析テスト実行
- [ ] パフォーマンス検証

## 🧪 テストプラン

### **単体テスト**
- [ ] 画像分析ツールのローカルファイル読み込みテスト
- [ ] 各種画像形式での動作確認
- [ ] エラーケース (ファイル不存在、権限エラー等) テスト

### **統合テスト**
- [ ] フロントエンド → ファイルアップロード → 画像分析の完全フロー
- [ ] 複数画像の連続処理テスト
- [ ] セッション管理との連携テスト

## 📊 成功指標

- [ ] グローバル変数の完全削除
- [ ] ローカルファイル保存を活用した画像分析の正常動作
- [ ] フロントエンドからの画像アップロード⇔分析の一貫したUX
- [ ] メモリ使用量の改善
- [ ] コードの可読性・保守性向上

## ⚠️ リスク・注意事項

### **技術リスク**
- ローカルファイルへのアクセス権限問題
- ファイル同期タイミングの問題
- 一時ファイルの削除タイミング

### **運用リスク**
- ディスク容量制限
- ファイル名衝突の可能性

## 🔄 ロールバック計画

問題発生時は以下の順序でロールバック:
1. グローバル変数実装の復旧
2. パラメータ propagation の復旧
3. フロントエンド Base64 送信の復旧

## 📝 実装時の注意点

### **コーディング規約準拠**
- Import文ファイル先頭配置
- 型アノテーション完備
- DIコンテナからのロガー注入
- エラーハンドリング実装

### **ファイルパス設計**
- セキュリティ: パストラバーサル攻撃防止
- 一意性: UUID等による重複防止
- クリーンアップ: 不要ファイルの定期削除

## 🔗 関連Issue・PR

- 前提: 既存ファイルアップロード機能 (実装済み)
- 将来: GCS統合による本格運用対応 (別Issue予定)