# 開発リファクタリング計画

## AgentManager リファクタリング計画

### 現状の問題点

#### 1. コードの重複
- `agent_manager.py` (約1700行) と `routing_strategy.py` で同じルーティングロジックが重複
- 戦略パターン導入により、多くのメソッドが不要に

#### 2. ハードコードされた定数
- 並列分析キーワード（15個）
- 順次分析キーワード（7個）
- エージェント応答検証パターン
- エラー判定キーワード
- フォールバック優先順位

#### 3. 未使用のレガシーコード
- ルーティングメッセージ生成システム（約200行）
- 専門家名抽出ロジック
- 各種理由説明生成メソッド

### リファクタリング手順

#### Phase 1: 定数の整理
1. `constants_additions.py`の内容を`constants.py`に統合
2. agent_manager.py内のハードコードされたリストを削除

#### Phase 2: 重複コードの削除
1. 戦略パターンで実装済みのルーティングメソッドを削除
   - `_check_force_routing()`
   - `_is_parallel_analysis_requested()`
   - `_is_sequential_analysis_requested()`
   - `_determine_specialist_agent()`

#### Phase 3: レガシーコードの削除
1. ルーティングメッセージ生成システムの削除
   - `_get_specialist_name_from_response()`
   - `_create_routing_message()`
   - 各種 `_get_*_reason()` メソッド

#### Phase 4: メソッドの統合
1. 類似機能のメソッドを統合
   - `_validate_routing_decision()` + `_auto_correct_routing()`
   - `_route_to_specific_agent()` + `_route_to_specific_agent_with_fallback()`

### 期待される効果

- **コード削減**: 約1700行 → 約800-900行（約50%削減）
- **保守性向上**: 重複排除により変更箇所が1箇所に
- **テスタビリティ向上**: 戦略パターンにより個別テストが容易に
- **拡張性向上**: 新しいルーティング戦略の追加が簡単に

### 注意事項

- 既存のAPIインターフェースは維持
- ADKランナー管理機能は影響を受けない
- 段階的にリファクタリングを実施し、各段階でテストを確認

## ADK移行による自動リファクタリング完了

### ✅ 実施済み項目

上記のリファクタリング計画は、**ADK標準ルーティングシステムへの移行**により自動的に解決されました：

#### 1. コード量大幅削減
- **旧実装**: 200行以上の複雑なルーティングロジック
- **新実装**: 50行程度のADK標準パターン
- **削減率**: 約75%のコード削減

#### 2. 重複コード削除
- ✅ 戦略パターンで統一
- ✅ ADK標準の`LlmAgent`と`transfer_to_agent()`に統合
- ✅ 複雑なキーワードマッチングロジック削除

#### 3. レガシーコード削除
- ✅ ルーティングメッセージ生成システム不要
- ✅ 専門家名抽出ロジック不要
- ✅ 複雑なエラーハンドリング不要

#### 4. 依存関係の整理
- ✅ CompositionRootパターンで統一
- ✅ DIコンテナからのロガー注入
- ✅ 型アノテーション完備

### 新しいシステム構成

```python
# ADK標準パターンの簡潔な実装
coordinator = LlmAgent(
    name="GenieUs子育てコーディネーター",
    instruction=instruction,
    sub_agents=sub_agents_list,
    tools=tools_list
)

# 既存システムとの互換性確保
adapter = AdkRoutingStrategyAdapter(
    adk_coordinator=adk_coordinator,
    logger=logger
)
```

### 今後のリファクタリング方針

#### 1. 継続的改善
- ADK標準機能の最大活用
- 専門エージェントの指示文最適化
- パフォーマンス監視と調整

#### 2. 機能拡張
- 新専門エージェントの追加パターン確立
- マルチモーダル対応の検討
- ADK新機能への対応

#### 3. 技術負債削減
- 旧バックアップファイルの整理
- 不要なテストケースの削除
- ドキュメントの更新

---

**結論**: 複雑な手動リファクタリング計画は、ADK標準パターンへの移行により一気に解決。コード量75%削減、保守性大幅向上、将来の拡張性確保を実現。